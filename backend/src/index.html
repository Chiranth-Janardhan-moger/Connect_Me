<!DOCTYPE html>
<html>
<head>
  <title>Bus Tracking</title>
  <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <style>
    #map { height: 90vh; width: 100%; }
  </style>
</head>
<body>
  <h2>Live Bus Tracking (Testing)</h2>
  <div id="map"></div>
  <script>
    const socket = io("http://localhost:5000");
    const map = L.map("map").setView([20.5937, 78.9629], 5); // India default
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "Â© OpenStreetMap contributors"
    }).addTo(map);
    
    // Custom bus icon
    const busIcon = L.icon({
      iconUrl: 'data:image/svg+xml;base64,' + btoa(`
        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="#FF6B00">
          <path d="M4 16c0 .88.39 1.67 1 2.22V20c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h8v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1.78c.61-.55 1-1.34 1-2.22V6c0-3.5-3.58-4-8-4s-8 .5-8 4v10zm3.5 1c-.83 0-1.5-.67-1.5-1.5S6.67 14 7.5 14s1.5.67 1.5 1.5S8.33 17 7.5 17zm9 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm1.5-6H6V6h12v5z"/>
        </svg>
      `),
      iconSize: [32, 32],
      iconAnchor: [16, 16],
      popupAnchor: [0, -16]
    });
    
    let markers = {};
    socket.on("init", (locations) => {
      Object.entries(locations).forEach(([id, loc]) => {
        addOrUpdateMarker(id, loc);
      });
    });
    socket.on("locationUpdate", (data) => {
      addOrUpdateMarker(data.userId, data);
    });
    function addOrUpdateMarker(id, data) {
      if (markers[id]) {
        markers[id].setLatLng([data.latitude, data.longitude]);
      } else {
        markers[id] = L.marker([data.latitude, data.longitude], {icon: busIcon})
          .addTo(map)
          .bindPopup(`${data.role}: ${id}`);
      }
    }
  </script>
</body>
</html>